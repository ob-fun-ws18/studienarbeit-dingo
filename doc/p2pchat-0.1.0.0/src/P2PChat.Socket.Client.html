<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-|
Module      : P2PChat.Socket.Client
Description : Defines Client Implementation
Copyright   : (c) Chris Brammer, 2019
                  Wolfgang Gabler, 2019
-}</span><span>
</span><a name="line-7"></a><span>
</span><a name="line-8"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">P2PChat.Socket.Client</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-9"></a><span>  </span><a href="P2PChat.Socket.Client.html#startSocketClient"><span class="hs-identifier hs-var">startSocketClient</span></a><span>
</span><a name="line-10"></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-11"></a><span>
</span><a name="line-12"></a><span class="hs-keyword">import</span><span> </span><a href="P2PChat.Common.html"><span class="hs-identifier">P2PChat.Common</span></a><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span> </span><a href="P2PChat.Socket.html"><span class="hs-identifier">P2PChat.Socket</span></a><span>
</span><a name="line-14"></a><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Aeson</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">A</span><span>
</span><a name="line-16"></a><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Maybe</span><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.IO</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.Timeout</span><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Network.Socket</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Concurrent</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.ByteString.Char8</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">B</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.ByteString.Lazy</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">BL</span><span>
</span><a name="line-25"></a><span>
</span><a name="line-26"></a><span class="hs-comment">-- | Starts the client socket and tries to connect to the host</span><span>
</span><a name="line-27"></a><span class="hs-identifier">startSocketClient</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span>  </span><span class="hs-comment">-- ^ Host to connect to (e.g &quot;127.0.0.1&quot;)</span><span>
</span><a name="line-28"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>  </span><span class="hs-comment">-- ^ Port to connect to</span><span>
</span><a name="line-29"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="P2PChat.Common.html#Global"><span class="hs-identifier hs-type">Global</span></a><span>  </span><span class="hs-comment">-- ^ Global State</span><span>
</span><a name="line-30"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="P2PChat.Common.html#Channels"><span class="hs-identifier hs-type">Channels</span></a><span>  </span><span class="hs-comment">-- ^ Communication Channels</span><span>
</span><a name="line-31"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">ThreadId</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- ^ Main ThreadId of the client</span><span>
</span><a name="line-32"></a><a name="startSocketClient"><a href="P2PChat.Socket.Client.html#startSocketClient"><span class="hs-identifier">startSocketClient</span></a></a><span> </span><a name="local-6989586621679092241"><a href="#local-6989586621679092241"><span class="hs-identifier">host</span></a></a><span> </span><a name="local-6989586621679092242"><a href="#local-6989586621679092242"><span class="hs-identifier">port</span></a></a><span> </span><a name="local-6989586621679092243"><a href="#local-6989586621679092243"><span class="hs-identifier">glob</span></a></a><span> </span><a name="local-6989586621679092244"><a href="#local-6989586621679092244"><span class="hs-identifier">chans</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-33"></a><span>  </span><a name="local-6989586621679092245"><a href="#local-6989586621679092245"><span class="hs-identifier">addrInfo</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getAddrInfo</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679092241"><span class="hs-identifier hs-var">host</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679092242"><span class="hs-identifier hs-var">port</span></a><span class="hs-special">)</span><span>
</span><a name="line-34"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679092246"><a href="#local-6989586621679092246"><span class="hs-identifier">serverAddr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">head</span><span> </span><a href="#local-6989586621679092245"><span class="hs-identifier hs-var">addrInfo</span></a><span>
</span><a name="line-35"></a><span>  </span><a name="local-6989586621679092426"><a href="#local-6989586621679092426"><span class="hs-identifier">sock</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">socket</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">addrFamily</span><span> </span><a href="#local-6989586621679092246"><span class="hs-identifier hs-var">serverAddr</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">Stream</span><span> </span><span class="hs-identifier hs-var">defaultProtocol</span><span>
</span><a name="line-36"></a><span>  </span><span class="hs-identifier hs-var">connect</span><span> </span><a href="#local-6989586621679092426"><span class="hs-identifier hs-var">sock</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">addrAddress</span><span> </span><a href="#local-6989586621679092246"><span class="hs-identifier hs-var">serverAddr</span></a><span class="hs-special">)</span><span>
</span><a name="line-37"></a><span>  </span><a name="local-6989586621679092631"><a href="#local-6989586621679092631"><span class="hs-identifier">hdl</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">socketToHandle</span><span> </span><a href="#local-6989586621679092426"><span class="hs-identifier hs-var">sock</span></a><span> </span><span class="hs-identifier hs-var">ReadWriteMode</span><span>
</span><a name="line-38"></a><span>  </span><span class="hs-identifier hs-var">hSetBuffering</span><span> </span><a href="#local-6989586621679092631"><span class="hs-identifier hs-var">hdl</span></a><span> </span><span class="hs-identifier hs-var">NoBuffering</span><span>
</span><a name="line-39"></a><span>  </span><a name="local-6989586621679092632"><a href="#local-6989586621679092632"><span class="hs-identifier">success</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="P2PChat.Socket.Client.html#handshake"><span class="hs-identifier hs-var">handshake</span></a><span> </span><a href="#local-6989586621679092631"><span class="hs-identifier hs-var">hdl</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">myUserName</span><span> </span><a href="#local-6989586621679092243"><span class="hs-identifier hs-var">glob</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">myUUID</span><span> </span><a href="#local-6989586621679092243"><span class="hs-identifier hs-var">glob</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">myHostPort</span><span> </span><a href="#local-6989586621679092243"><span class="hs-identifier hs-var">glob</span></a><span class="hs-special">)</span><span>
</span><a name="line-40"></a><span>  </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679092632"><span class="hs-identifier hs-var">success</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-41"></a><span>    </span><a name="local-6989586621679092633"><a href="#local-6989586621679092633"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">forkIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="P2PChat.Socket.Client.html#runClientSock"><span class="hs-identifier hs-var">runClientSock</span></a><span> </span><a href="#local-6989586621679092243"><span class="hs-identifier hs-var">glob</span></a><span> </span><a href="#local-6989586621679092244"><span class="hs-identifier hs-var">chans</span></a><span> </span><a href="#local-6989586621679092631"><span class="hs-identifier hs-var">hdl</span></a><span>
</span><a name="line-42"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679092633"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-43"></a><span>  </span><span class="hs-keyword">else</span><span>
</span><a name="line-44"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-45"></a><span>
</span><a name="line-46"></a><span class="hs-comment">-- | Send the handshake to the server</span><span>
</span><a name="line-47"></a><span class="hs-identifier">handshake</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Handle</span><span>  </span><span class="hs-comment">-- ^ Handle to the server</span><span>
</span><a name="line-48"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>  </span><span class="hs-comment">-- ^ Username to register as</span><span>
</span><a name="line-49"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>  </span><span class="hs-comment">-- ^ UUID of this client</span><span>
</span><a name="line-50"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>  </span><span class="hs-comment">-- ^ Port we are running on</span><span>
</span><a name="line-51"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-comment">-- ^ True if successfull</span><span>
</span><a name="line-52"></a><a name="handshake"><a href="P2PChat.Socket.Client.html#handshake"><span class="hs-identifier">handshake</span></a></a><span> </span><a name="local-6989586621679092634"><a href="#local-6989586621679092634"><span class="hs-identifier">hdl</span></a></a><span> </span><a name="local-6989586621679092635"><a href="#local-6989586621679092635"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621679092636"><a href="#local-6989586621679092636"><span class="hs-identifier">uuid</span></a></a><span> </span><a name="local-6989586621679092637"><a href="#local-6989586621679092637"><span class="hs-identifier">port</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-53"></a><span>  </span><span class="hs-identifier hs-var">B.hPutStrLn</span><span> </span><a href="#local-6989586621679092634"><span class="hs-identifier hs-var">hdl</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BL.toStrict</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">A.encode</span><span> </span><span class="hs-special">(</span><a href="P2PChat.Common.html#jsonConnect"><span class="hs-identifier hs-var">jsonConnect</span></a><span> </span><a href="#local-6989586621679092635"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679092636"><span class="hs-identifier hs-var">uuid</span></a><span> </span><a href="#local-6989586621679092637"><span class="hs-identifier hs-var">port</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-54"></a><span>  </span><a name="local-6989586621679092638"><a href="#local-6989586621679092638"><span class="hs-identifier">eof</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">hIsEOF</span><span> </span><a href="#local-6989586621679092634"><span class="hs-identifier hs-var">hdl</span></a><span>
</span><a name="line-55"></a><span>  </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679092638"><span class="hs-identifier hs-var">eof</span></a><span> </span><span class="hs-keyword">then</span><span>
</span><a name="line-56"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-57"></a><span>  </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-58"></a><span>    </span><a name="local-6989586621679092639"><a href="#local-6989586621679092639"><span class="hs-identifier">input</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">B.hGetLine</span><span> </span><a href="#local-6989586621679092634"><span class="hs-identifier hs-var">hdl</span></a><span>
</span><a name="line-59"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679092640"><a href="#local-6989586621679092640"><span class="hs-identifier">json</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">A.decode</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BL.fromStrict</span><span> </span><a href="#local-6989586621679092639"><span class="hs-identifier hs-var">input</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="P2PChat.Common.html#JsonMessage"><span class="hs-identifier hs-type">JsonMessage</span></a><span>
</span><a name="line-60"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679092640"><span class="hs-identifier hs-var">json</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-61"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679092641"><a href="#local-6989586621679092641"><span class="hs-identifier">j</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="P2PChat.Common.html#isJsonOK"><span class="hs-identifier hs-var">isJsonOK</span></a><span> </span><a href="#local-6989586621679092641"><span class="hs-identifier hs-var">j</span></a><span>
</span><a name="line-62"></a><span>      </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-63"></a><span>
</span><a name="line-64"></a><span class="hs-comment">-- | Main routine for the client</span><span>
</span><a name="line-65"></a><span class="hs-identifier">runClientSock</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="P2PChat.Common.html#Global"><span class="hs-identifier hs-type">Global</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="P2PChat.Common.html#Channels"><span class="hs-identifier hs-type">Channels</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Handle</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-66"></a><a name="runClientSock"><a href="P2PChat.Socket.Client.html#runClientSock"><span class="hs-identifier">runClientSock</span></a></a><span> </span><a name="local-6989586621679092642"><a href="#local-6989586621679092642"><span class="hs-identifier">glob</span></a></a><span> </span><a name="local-6989586621679092643"><a href="#local-6989586621679092643"><span class="hs-identifier">chans</span></a></a><span> </span><a name="local-6989586621679092644"><a href="#local-6989586621679092644"><span class="hs-identifier">handle</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-67"></a><span>  </span><a name="local-6989586621679092645"><a href="#local-6989586621679092645"><span class="hs-identifier">outputChan</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newChan</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Chan</span><span> </span><a href="P2PChat.Common.html#JsonMessage"><span class="hs-identifier hs-type">JsonMessage</span></a><span class="hs-special">)</span><span>
</span><a name="line-68"></a><span>  </span><a name="local-6989586621679092646"><a href="#local-6989586621679092646"><span class="hs-identifier">readId</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">forkIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="P2PChat.Socket.Client.html#readClientSock"><span class="hs-identifier hs-var">readClientSock</span></a><span> </span><a href="#local-6989586621679092644"><span class="hs-identifier hs-var">handle</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">csock</span><span> </span><a href="#local-6989586621679092643"><span class="hs-identifier hs-var">chans</span></a><span class="hs-special">)</span><span>
</span><a name="line-69"></a><span>  </span><a name="local-6989586621679092647"><a href="#local-6989586621679092647"><span class="hs-identifier">outputId</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">forkIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="P2PChat.Socket.Client.html#runSocketOutput"><span class="hs-identifier hs-var">runSocketOutput</span></a><span> </span><a href="#local-6989586621679092644"><span class="hs-identifier hs-var">handle</span></a><span> </span><a href="#local-6989586621679092645"><span class="hs-identifier hs-var">outputChan</span></a><span>
</span><a name="line-70"></a><span>  </span><a href="P2PChat.Socket.Client.html#loopClientSock"><span class="hs-identifier hs-var">loopClientSock</span></a><span> </span><a href="#local-6989586621679092642"><span class="hs-identifier hs-var">glob</span></a><span> </span><a href="#local-6989586621679092643"><span class="hs-identifier hs-var">chans</span></a><span> </span><a href="#local-6989586621679092644"><span class="hs-identifier hs-var">handle</span></a><span> </span><a href="#local-6989586621679092645"><span class="hs-identifier hs-var">outputChan</span></a><span>
</span><a name="line-71"></a><span>  </span><span class="hs-identifier hs-var">hClose</span><span> </span><a href="#local-6989586621679092644"><span class="hs-identifier hs-var">handle</span></a><span>
</span><a name="line-72"></a><span>  </span><span class="hs-identifier hs-var">killThread</span><span> </span><a href="#local-6989586621679092646"><span class="hs-identifier hs-var">readId</span></a><span>
</span><a name="line-73"></a><span>  </span><span class="hs-identifier hs-var">killThread</span><span> </span><a href="#local-6989586621679092647"><span class="hs-identifier hs-var">outputId</span></a><span>
</span><a name="line-74"></a><span>
</span><a name="line-75"></a><span class="hs-comment">-- | Client loop, forwards events appropriately to channels</span><span>
</span><a name="line-76"></a><span class="hs-identifier">loopClientSock</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="P2PChat.Common.html#Global"><span class="hs-identifier hs-type">Global</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="P2PChat.Common.html#Channels"><span class="hs-identifier hs-type">Channels</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Handle</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Chan</span><span> </span><a href="P2PChat.Common.html#JsonMessage"><span class="hs-identifier hs-type">JsonMessage</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-77"></a><a name="loopClientSock"><a href="P2PChat.Socket.Client.html#loopClientSock"><span class="hs-identifier">loopClientSock</span></a></a><span> </span><a name="local-6989586621679092648"><a href="#local-6989586621679092648"><span class="hs-identifier">glob</span></a></a><span> </span><a name="local-6989586621679092649"><a href="#local-6989586621679092649"><span class="hs-identifier">chans</span></a></a><span> </span><a name="local-6989586621679092650"><a href="#local-6989586621679092650"><span class="hs-identifier">handle</span></a></a><span> </span><a name="local-6989586621679092651"><a href="#local-6989586621679092651"><span class="hs-identifier">chan</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-78"></a><span>  </span><a name="local-6989586621679092652"><a href="#local-6989586621679092652"><span class="hs-identifier">event</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readChan</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">csock</span><span> </span><a href="#local-6989586621679092649"><span class="hs-identifier hs-var">chans</span></a><span class="hs-special">)</span><span>
</span><a name="line-79"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679092652"><span class="hs-identifier hs-var">event</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-80"></a><span>    </span><a name="local-6989586621679092653"><a href="#local-6989586621679092653"><span class="hs-identifier">s</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="P2PChat.Common.html#SockHostConnect"><span class="hs-identifier hs-var">SockHostConnect</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">writeChan</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">cmain</span><span> </span><a href="#local-6989586621679092649"><span class="hs-identifier hs-var">chans</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679092653"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-81"></a><span>    </span><a name="local-6989586621679092654"><a href="#local-6989586621679092654"><span class="hs-identifier">s</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="P2PChat.Common.html#SockHostDisconnect"><span class="hs-identifier hs-var">SockHostDisconnect</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">writeChan</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">cmain</span><span> </span><a href="#local-6989586621679092649"><span class="hs-identifier hs-var">chans</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679092654"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-82"></a><span>    </span><a name="local-6989586621679092655"><a href="#local-6989586621679092655"><span class="hs-identifier">s</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="P2PChat.Common.html#SockMsgIn"><span class="hs-identifier hs-var">SockMsgIn</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">writeChan</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">cmain</span><span> </span><a href="#local-6989586621679092649"><span class="hs-identifier hs-var">chans</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679092655"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-83"></a><span>    </span><a href="P2PChat.Common.html#SockMsgOut"><span class="hs-identifier hs-var">SockMsgOut</span></a><span> </span><a name="local-6989586621679092656"><a href="#local-6989586621679092656"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">writeChan</span><span> </span><a href="#local-6989586621679092651"><span class="hs-identifier hs-var">chan</span></a><span> </span><span class="hs-special">(</span><a href="P2PChat.Common.html#jsonMessageSend"><span class="hs-identifier hs-var">jsonMessageSend</span></a><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><a href="#local-6989586621679092656"><span class="hs-identifier hs-var">msg</span></a><span class="hs-special">)</span><span>
</span><a name="line-84"></a><span>    </span><a name="local-6989586621679092657"><a href="#local-6989586621679092657"><span class="hs-identifier">s</span></a></a><span class="hs-glyph">@</span><a href="P2PChat.Common.html#SockClientDisconnect"><span class="hs-identifier hs-var">SockClientDisconnect</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">writeChan</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">cmain</span><span> </span><a href="#local-6989586621679092649"><span class="hs-identifier hs-var">chans</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679092657"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-85"></a><span>  </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><a href="P2PChat.Common.html#isDisconnect"><span class="hs-identifier hs-var">isDisconnect</span></a><span> </span><a href="#local-6989586621679092652"><span class="hs-identifier hs-var">event</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="P2PChat.Socket.Client.html#loopClientSock"><span class="hs-identifier hs-var">loopClientSock</span></a><span> </span><a href="#local-6989586621679092648"><span class="hs-identifier hs-var">glob</span></a><span> </span><a href="#local-6989586621679092649"><span class="hs-identifier hs-var">chans</span></a><span> </span><a href="#local-6989586621679092650"><span class="hs-identifier hs-var">handle</span></a><span> </span><a href="#local-6989586621679092651"><span class="hs-identifier hs-var">chan</span></a><span>
</span><a name="line-86"></a><span>
</span><a name="line-87"></a><span class="hs-comment">-- | Read loop for the client with timeout</span><span>
</span><a name="line-88"></a><span class="hs-identifier">readClientSock</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Handle</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Chan</span><span> </span><a href="P2PChat.Common.html#Event"><span class="hs-identifier hs-type">Event</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-89"></a><a name="readClientSock"><a href="P2PChat.Socket.Client.html#readClientSock"><span class="hs-identifier">readClientSock</span></a></a><span> </span><a name="local-6989586621679092658"><a href="#local-6989586621679092658"><span class="hs-identifier">hdl</span></a></a><span> </span><a name="local-6989586621679092659"><a href="#local-6989586621679092659"><span class="hs-identifier">chan</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-90"></a><span>  </span><a name="local-6989586621679092660"><a href="#local-6989586621679092660"><span class="hs-identifier">input</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">timeout</span><span> </span><span class="hs-number">1000000</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="P2PChat.Socket.html#readHandle"><span class="hs-identifier hs-var">readHandle</span></a><span> </span><a href="#local-6989586621679092658"><span class="hs-identifier hs-var">hdl</span></a><span>
</span><a name="line-91"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679092660"><span class="hs-identifier hs-var">input</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-92"></a><span>    </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679092661"><a href="#local-6989586621679092661"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-93"></a><span>      </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679092661"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-94"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679092662"><a href="#local-6989586621679092662"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-95"></a><span>          </span><span class="hs-keyword">case</span><span> </span><a href="P2PChat.Common.html#jsonParse"><span class="hs-identifier hs-var">jsonParse</span></a><span> </span><a href="#local-6989586621679092662"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-96"></a><span>            </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679092663"><a href="#local-6989586621679092663"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="P2PChat.Socket.Client.html#handleInput"><span class="hs-identifier hs-var">handleInput</span></a><span> </span><a href="#local-6989586621679092659"><span class="hs-identifier hs-var">chan</span></a><span> </span><a href="#local-6989586621679092663"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-97"></a><span>            </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">putStrLn</span><span> </span><span class="hs-string">&quot;DEBUG: Client Reading unknown msg&quot;</span><span>
</span><a name="line-98"></a><span>          </span><a href="P2PChat.Socket.Client.html#readClientSock"><span class="hs-identifier hs-var">readClientSock</span></a><span> </span><a href="#local-6989586621679092658"><span class="hs-identifier hs-var">hdl</span></a><span> </span><a href="#local-6989586621679092659"><span class="hs-identifier hs-var">chan</span></a><span>
</span><a name="line-99"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">writeChan</span><span> </span><a href="#local-6989586621679092659"><span class="hs-identifier hs-var">chan</span></a><span> </span><a href="P2PChat.Common.html#SockClientDisconnect"><span class="hs-identifier hs-var">SockClientDisconnect</span></a><span> </span><span class="hs-comment">-- disconnect</span><span>
</span><a name="line-100"></a><span>    </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">writeChan</span><span> </span><a href="#local-6989586621679092659"><span class="hs-identifier hs-var">chan</span></a><span> </span><a href="P2PChat.Common.html#SockClientDisconnect"><span class="hs-identifier hs-var">SockClientDisconnect</span></a><span> </span><span class="hs-comment">-- timeout  </span><span>
</span><a name="line-101"></a><span>
</span><a name="line-102"></a><span class="hs-comment">-- | Routine to handle input of the client. Parsing of Json Messages</span><span>
</span><a name="line-103"></a><span class="hs-identifier">handleInput</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Chan</span><span> </span><a href="P2PChat.Common.html#Event"><span class="hs-identifier hs-type">Event</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="P2PChat.Common.html#JsonMessage"><span class="hs-identifier hs-type">JsonMessage</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-104"></a><a name="handleInput"><a href="P2PChat.Socket.Client.html#handleInput"><span class="hs-identifier">handleInput</span></a></a><span> </span><a name="local-6989586621679092664"><a href="#local-6989586621679092664"><span class="hs-identifier">chan</span></a></a><span> </span><a name="local-6989586621679092665"><a href="#local-6989586621679092665"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679092665"><span class="hs-identifier hs-var">msg</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-105"></a><span>  </span><span class="hs-special">(</span><a href="P2PChat.Common.html#JsonMessage"><span class="hs-identifier hs-var">JsonMessage</span></a><span> </span><span class="hs-string">&quot;message&quot;</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="P2PChat.Common.html#JsonPayloadMessage"><span class="hs-identifier hs-var">JsonPayloadMessage</span></a><span> </span><a name="local-6989586621679092666"><a href="#local-6989586621679092666"><span class="hs-identifier">user</span></a></a><span> </span><a name="local-6989586621679092667"><a href="#local-6989586621679092667"><span class="hs-identifier">m</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">writeChan</span><span> </span><a href="#local-6989586621679092664"><span class="hs-identifier hs-var">chan</span></a><span> </span><span class="hs-special">(</span><a href="P2PChat.Common.html#SockMsgIn"><span class="hs-identifier hs-var">SockMsgIn</span></a><span> </span><a href="#local-6989586621679092666"><span class="hs-identifier hs-var">user</span></a><span> </span><a href="#local-6989586621679092667"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-106"></a><span>  </span><span class="hs-special">(</span><a href="P2PChat.Common.html#JsonMessage"><span class="hs-identifier hs-var">JsonMessage</span></a><span> </span><span class="hs-string">&quot;clientConnected&quot;</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="P2PChat.Common.html#JsonPayloadClientConnected"><span class="hs-identifier hs-var">JsonPayloadClientConnected</span></a><span> </span><a name="local-6989586621679092668"><a href="#local-6989586621679092668"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679092669"><a href="#local-6989586621679092669"><span class="hs-identifier">ms</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">writeChan</span><span> </span><a href="#local-6989586621679092664"><span class="hs-identifier hs-var">chan</span></a><span> </span><span class="hs-special">(</span><a href="P2PChat.Common.html#SockHostConnect"><span class="hs-identifier hs-var">SockHostConnect</span></a><span> </span><a href="#local-6989586621679092668"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621679092669"><span class="hs-identifier hs-var">ms</span></a><span class="hs-special">)</span><span>
</span><a name="line-107"></a><span>  </span><span class="hs-special">(</span><a href="P2PChat.Common.html#JsonMessage"><span class="hs-identifier hs-var">JsonMessage</span></a><span> </span><span class="hs-string">&quot;clientDisconnected&quot;</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="P2PChat.Common.html#JsonPayloadClientDisconnected"><span class="hs-identifier hs-var">JsonPayloadClientDisconnected</span></a><span> </span><a name="local-6989586621679092670"><a href="#local-6989586621679092670"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679092671"><a href="#local-6989586621679092671"><span class="hs-identifier">ms</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">writeChan</span><span> </span><a href="#local-6989586621679092664"><span class="hs-identifier hs-var">chan</span></a><span> </span><span class="hs-special">(</span><a href="P2PChat.Common.html#SockHostDisconnect"><span class="hs-identifier hs-var">SockHostDisconnect</span></a><span> </span><a href="#local-6989586621679092670"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621679092671"><span class="hs-identifier hs-var">ms</span></a><span class="hs-special">)</span><span>
</span><a name="line-108"></a><span>  </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-109"></a><span>
</span><a name="line-110"></a><span class="hs-comment">-- | Socket output for the client, also sends heartbeat automatically</span><span>
</span><a name="line-111"></a><span class="hs-identifier">runSocketOutput</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Handle</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Chan</span><span> </span><a href="P2PChat.Common.html#JsonMessage"><span class="hs-identifier hs-type">JsonMessage</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-112"></a><a name="runSocketOutput"><a href="P2PChat.Socket.Client.html#runSocketOutput"><span class="hs-identifier">runSocketOutput</span></a></a><span> </span><a name="local-6989586621679092672"><a href="#local-6989586621679092672"><span class="hs-identifier">hdl</span></a></a><span> </span><a name="local-6989586621679092673"><a href="#local-6989586621679092673"><span class="hs-identifier">chan</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-113"></a><span>  </span><a name="local-6989586621679092674"><a href="#local-6989586621679092674"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">timeout</span><span> </span><span class="hs-number">500000</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">readChan</span><span> </span><a href="#local-6989586621679092673"><span class="hs-identifier hs-var">chan</span></a><span>
</span><a name="line-114"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679092674"><span class="hs-identifier hs-var">msg</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-115"></a><span>    </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679092675"><a href="#local-6989586621679092675"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">B.hPutStrLn</span><span> </span><a href="#local-6989586621679092672"><span class="hs-identifier hs-var">hdl</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">BL.toStrict</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">A.encode</span><span> </span><a href="#local-6989586621679092675"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-116"></a><span>    </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">B.hPutStrLn</span><span> </span><a href="#local-6989586621679092672"><span class="hs-identifier hs-var">hdl</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">BL.toStrict</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">A.encode</span><span> </span><a href="P2PChat.Common.html#jsonHeartbeat"><span class="hs-identifier hs-var">jsonHeartbeat</span></a><span>
</span><a name="line-117"></a><span>  </span><a href="P2PChat.Socket.Client.html#runSocketOutput"><span class="hs-identifier hs-var">runSocketOutput</span></a><span> </span><a href="#local-6989586621679092672"><span class="hs-identifier hs-var">hdl</span></a><span> </span><a href="#local-6989586621679092673"><span class="hs-identifier hs-var">chan</span></a><span>  </span></pre></body></html>