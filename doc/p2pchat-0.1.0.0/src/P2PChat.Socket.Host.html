<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-|
Module      : P2PChat.Socket.Host
Description : Defines Host Implementation
Copyright   : (c) Chris Brammer, 2019
                  Wolfgang Gabler, 2019
-}</span><span>
</span><a name="line-7"></a><span>
</span><a name="line-8"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">P2PChat.Socket.Host</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-9"></a><span>  </span><a href="P2PChat.Socket.Host.html#startSocketHost"><span class="hs-identifier hs-var">startSocketHost</span></a><span>
</span><a name="line-10"></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-11"></a><span>
</span><a name="line-12"></a><span class="hs-keyword">import</span><span> </span><a href="P2PChat.Common.html"><span class="hs-identifier">P2PChat.Common</span></a><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span> </span><a href="P2PChat.Socket.html"><span class="hs-identifier">P2PChat.Socket</span></a><span>
</span><a name="line-14"></a><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Aeson</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">A</span><span>
</span><a name="line-16"></a><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.IO</span><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Network.Socket</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Concurrent</span><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Concurrent.Chan</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.Timeout</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.ByteString.Char8</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">B</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.ByteString.Lazy</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">BL</span><span>
</span><a name="line-25"></a><span>
</span><a name="line-26"></a><span class="hs-comment">-- | Client Connection</span><span>
</span><a name="line-27"></a><span class="hs-keyword">data</span><span> </span><a name="SockCLientConnection"><a href="P2PChat.Socket.Host.html#SockCLientConnection"><span class="hs-identifier">SockCLientConnection</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="SockCLientConnection"><a href="P2PChat.Socket.Host.html#SockCLientConnection"><span class="hs-identifier">SockCLientConnection</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-28"></a><span>  </span><a name="member"><a href="P2PChat.Socket.Host.html#member"><span class="hs-identifier">member</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="P2PChat.Common.html#Member"><span class="hs-identifier hs-type">Member</span></a><span>
</span><a name="line-29"></a><span class="hs-special">,</span><span> </span><a name="clientHandle"><a href="P2PChat.Socket.Host.html#clientHandle"><span class="hs-identifier">clientHandle</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Handle</span><span>
</span><a name="line-30"></a><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">)</span><span>
</span><a name="line-31"></a><span>
</span><a name="line-32"></a><span class="hs-comment">-- | Socket Events</span><span>
</span><a name="line-33"></a><span class="hs-keyword">data</span><span> </span><a name="SockEvent"><a href="P2PChat.Socket.Host.html#SockEvent"><span class="hs-identifier">SockEvent</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="NewClient"><a href="P2PChat.Socket.Host.html#NewClient"><span class="hs-identifier">NewClient</span></a></a><span> </span><a href="P2PChat.Socket.Host.html#SockCLientConnection"><span class="hs-identifier hs-type">SockCLientConnection</span></a><span>
</span><a name="line-34"></a><span>               </span><span class="hs-glyph">|</span><span> </span><a name="SockInput"><a href="P2PChat.Socket.Host.html#SockInput"><span class="hs-identifier">SockInput</span></a></a><span> </span><a href="P2PChat.Socket.Host.html#SockCLientConnection"><span class="hs-identifier hs-type">SockCLientConnection</span></a><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-comment">-- input from a sock</span><span>
</span><a name="line-35"></a><span>               </span><span class="hs-glyph">|</span><span> </span><a name="SockOutput"><a href="P2PChat.Socket.Host.html#SockOutput"><span class="hs-identifier">SockOutput</span></a></a><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-comment">-- msg to output to all clients</span><span>
</span><a name="line-36"></a><span>               </span><span class="hs-glyph">|</span><span> </span><a name="SockDisconnect"><a href="P2PChat.Socket.Host.html#SockDisconnect"><span class="hs-identifier">SockDisconnect</span></a></a><span> </span><a href="P2PChat.Socket.Host.html#SockCLientConnection"><span class="hs-identifier hs-type">SockCLientConnection</span></a><span> </span><span class="hs-comment">-- Sock disconnected</span><span>
</span><a name="line-37"></a><span>
</span><a name="line-38"></a><span class="hs-comment">-- | Starts the Host Socket and a thread to manage it</span><span>
</span><a name="line-39"></a><span class="hs-identifier">startSocketHost</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="P2PChat.Common.html#Global"><span class="hs-identifier hs-type">Global</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="P2PChat.Common.html#Channels"><span class="hs-identifier hs-type">Channels</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">ThreadId</span><span>
</span><a name="line-40"></a><a name="startSocketHost"><a href="P2PChat.Socket.Host.html#startSocketHost"><span class="hs-identifier">startSocketHost</span></a></a><span> </span><a name="local-6989586621679094660"><a href="#local-6989586621679094660"><span class="hs-identifier">glob</span></a></a><span> </span><a name="local-6989586621679094661"><a href="#local-6989586621679094661"><span class="hs-identifier">chan</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-41"></a><span>  </span><a name="local-6989586621679094662"><a href="#local-6989586621679094662"><span class="hs-identifier">sock</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">socket</span><span> </span><span class="hs-identifier hs-var">AF_INET</span><span> </span><span class="hs-identifier hs-var">Stream</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-42"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679094663"><a href="#local-6989586621679094663"><span class="hs-identifier">addr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">SockAddrInet</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">toEnum</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">myHostPort</span><span> </span><a href="#local-6989586621679094660"><span class="hs-identifier hs-var">glob</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">iNADDR_ANY</span><span>
</span><a name="line-43"></a><span>  </span><span class="hs-identifier hs-var">bind</span><span> </span><a href="#local-6989586621679094662"><span class="hs-identifier hs-var">sock</span></a><span> </span><a href="#local-6989586621679094663"><span class="hs-identifier hs-var">addr</span></a><span>
</span><a name="line-44"></a><span>  </span><span class="hs-identifier hs-var">listen</span><span> </span><a href="#local-6989586621679094662"><span class="hs-identifier hs-var">sock</span></a><span> </span><span class="hs-number">2</span><span>
</span><a name="line-45"></a><span>  </span><span class="hs-identifier hs-var">forkIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="P2PChat.Socket.Host.html#runHostSock"><span class="hs-identifier hs-var">runHostSock</span></a><span> </span><a href="#local-6989586621679094660"><span class="hs-identifier hs-var">glob</span></a><span> </span><a href="#local-6989586621679094661"><span class="hs-identifier hs-var">chan</span></a><span> </span><a href="#local-6989586621679094662"><span class="hs-identifier hs-var">sock</span></a><span>
</span><a name="line-46"></a><span>
</span><a name="line-47"></a><span class="hs-comment">-- | Sets up threads for the host. Thread to accept clients, thread to handle events</span><span>
</span><a name="line-48"></a><span class="hs-identifier">runHostSock</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="P2PChat.Common.html#Global"><span class="hs-identifier hs-type">Global</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="P2PChat.Common.html#Channels"><span class="hs-identifier hs-type">Channels</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Socket</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-49"></a><a name="runHostSock"><a href="P2PChat.Socket.Host.html#runHostSock"><span class="hs-identifier">runHostSock</span></a></a><span> </span><a name="local-6989586621679094664"><a href="#local-6989586621679094664"><span class="hs-identifier">glob</span></a></a><span> </span><a name="local-6989586621679094665"><a href="#local-6989586621679094665"><span class="hs-identifier">chans</span></a></a><span> </span><a name="local-6989586621679094666"><a href="#local-6989586621679094666"><span class="hs-identifier">sock</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-50"></a><span>  </span><a name="local-6989586621679094667"><a href="#local-6989586621679094667"><span class="hs-identifier">clientChan</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newChan</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Chan</span><span> </span><a href="P2PChat.Socket.Host.html#SockEvent"><span class="hs-identifier hs-type">SockEvent</span></a><span class="hs-special">)</span><span>
</span><a name="line-51"></a><span>  </span><a name="local-6989586621679094668"><a href="#local-6989586621679094668"><span class="hs-identifier">clientMsgChan</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newChan</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Chan</span><span> </span><a href="P2PChat.Common.html#JsonMessage"><span class="hs-identifier hs-type">JsonMessage</span></a><span class="hs-special">)</span><span>
</span><a name="line-52"></a><span>  </span><a name="local-6989586621679094669"><a href="#local-6989586621679094669"><span class="hs-identifier">sockhandlerId</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">forkIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="P2PChat.Socket.Host.html#runSockEventHandler"><span class="hs-identifier hs-var">runSockEventHandler</span></a><span> </span><a href="#local-6989586621679094667"><span class="hs-identifier hs-var">clientChan</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">csock</span><span> </span><a href="#local-6989586621679094665"><span class="hs-identifier hs-var">chans</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679094668"><span class="hs-identifier hs-var">clientMsgChan</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-53"></a><span>  </span><a name="local-6989586621679094670"><a href="#local-6989586621679094670"><span class="hs-identifier">acceptId</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">forkIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="P2PChat.Socket.Host.html#runAcceptLoop"><span class="hs-identifier hs-var">runAcceptLoop</span></a><span> </span><a href="#local-6989586621679094666"><span class="hs-identifier hs-var">sock</span></a><span> </span><a href="#local-6989586621679094667"><span class="hs-identifier hs-var">clientChan</span></a><span> </span><a href="#local-6989586621679094668"><span class="hs-identifier hs-var">clientMsgChan</span></a><span>
</span><a name="line-54"></a><span>  </span><a href="P2PChat.Socket.Host.html#loopHostHandler"><span class="hs-identifier hs-var">loopHostHandler</span></a><span> </span><a href="#local-6989586621679094664"><span class="hs-identifier hs-var">glob</span></a><span> </span><a href="#local-6989586621679094665"><span class="hs-identifier hs-var">chans</span></a><span> </span><a href="#local-6989586621679094668"><span class="hs-identifier hs-var">clientMsgChan</span></a><span>
</span><a name="line-55"></a><span>  </span><span class="hs-identifier hs-var">close</span><span> </span><a href="#local-6989586621679094666"><span class="hs-identifier hs-var">sock</span></a><span>
</span><a name="line-56"></a><span>  </span><span class="hs-identifier hs-var">killThread</span><span> </span><a href="#local-6989586621679094669"><span class="hs-identifier hs-var">sockhandlerId</span></a><span>
</span><a name="line-57"></a><span>  </span><span class="hs-identifier hs-var">killThread</span><span> </span><a href="#local-6989586621679094670"><span class="hs-identifier hs-var">acceptId</span></a><span>
</span><a name="line-58"></a><span>
</span><a name="line-59"></a><span class="hs-comment">-- | Forwards events to the appropriate channels</span><span>
</span><a name="line-60"></a><span class="hs-identifier">loopHostHandler</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="P2PChat.Common.html#Global"><span class="hs-identifier hs-type">Global</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="P2PChat.Common.html#Channels"><span class="hs-identifier hs-type">Channels</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Chan</span><span> </span><a href="P2PChat.Common.html#JsonMessage"><span class="hs-identifier hs-type">JsonMessage</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-61"></a><a name="loopHostHandler"><a href="P2PChat.Socket.Host.html#loopHostHandler"><span class="hs-identifier">loopHostHandler</span></a></a><span> </span><a name="local-6989586621679094671"><a href="#local-6989586621679094671"><span class="hs-identifier">glob</span></a></a><span> </span><a name="local-6989586621679094672"><a href="#local-6989586621679094672"><span class="hs-identifier">chans</span></a></a><span> </span><a name="local-6989586621679094673"><a href="#local-6989586621679094673"><span class="hs-identifier">chanJson</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-62"></a><span>  </span><a name="local-6989586621679094674"><a href="#local-6989586621679094674"><span class="hs-identifier">event</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readChan</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">csock</span><span> </span><a href="#local-6989586621679094672"><span class="hs-identifier hs-var">chans</span></a><span class="hs-special">)</span><span>
</span><a name="line-63"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679094674"><span class="hs-identifier hs-var">event</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-64"></a><span>    </span><a name="local-6989586621679094675"><a href="#local-6989586621679094675"><span class="hs-identifier">s</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="P2PChat.Common.html#SockHostConnect"><span class="hs-identifier hs-var">SockHostConnect</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">writeChan</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">cmain</span><span> </span><a href="#local-6989586621679094672"><span class="hs-identifier hs-var">chans</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679094675"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-65"></a><span>    </span><a name="local-6989586621679094676"><a href="#local-6989586621679094676"><span class="hs-identifier">s</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="P2PChat.Common.html#SockHostDisconnect"><span class="hs-identifier hs-var">SockHostDisconnect</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">writeChan</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">cmain</span><span> </span><a href="#local-6989586621679094672"><span class="hs-identifier hs-var">chans</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679094676"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-66"></a><span>    </span><a name="local-6989586621679094677"><a href="#local-6989586621679094677"><span class="hs-identifier">s</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="P2PChat.Common.html#SockMsgIn"><span class="hs-identifier hs-var">SockMsgIn</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">writeChan</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">cmain</span><span> </span><a href="#local-6989586621679094672"><span class="hs-identifier hs-var">chans</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679094677"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-67"></a><span>    </span><a href="P2PChat.Common.html#SockMsgOut"><span class="hs-identifier hs-var">SockMsgOut</span></a><span> </span><a name="local-6989586621679094678"><a href="#local-6989586621679094678"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">writeChan</span><span> </span><a href="#local-6989586621679094673"><span class="hs-identifier hs-var">chanJson</span></a><span> </span><span class="hs-special">(</span><a href="P2PChat.Common.html#jsonMessageSend"><span class="hs-identifier hs-var">jsonMessageSend</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">myUserName</span><span> </span><a href="#local-6989586621679094671"><span class="hs-identifier hs-var">glob</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679094678"><span class="hs-identifier hs-var">msg</span></a><span class="hs-special">)</span><span>
</span><a name="line-68"></a><span>    </span><a name="local-6989586621679094679"><a href="#local-6989586621679094679"><span class="hs-identifier">s</span></a></a><span class="hs-glyph">@</span><a href="P2PChat.Common.html#SockClientDisconnect"><span class="hs-identifier hs-var">SockClientDisconnect</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">writeChan</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">cmain</span><span> </span><a href="#local-6989586621679094672"><span class="hs-identifier hs-var">chans</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679094679"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-69"></a><span>  </span><a href="P2PChat.Socket.Host.html#loopHostHandler"><span class="hs-identifier hs-var">loopHostHandler</span></a><span> </span><a href="#local-6989586621679094671"><span class="hs-identifier hs-var">glob</span></a><span> </span><a href="#local-6989586621679094672"><span class="hs-identifier hs-var">chans</span></a><span> </span><a href="#local-6989586621679094673"><span class="hs-identifier hs-var">chanJson</span></a><span>
</span><a name="line-70"></a><span>
</span><a name="line-71"></a><span class="hs-comment">-- | Accepts new clients and handle the Handshake between Client/Host</span><span>
</span><a name="line-72"></a><span class="hs-identifier">runAcceptLoop</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Socket</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Chan</span><span> </span><a href="P2PChat.Socket.Host.html#SockEvent"><span class="hs-identifier hs-type">SockEvent</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Chan</span><span> </span><a href="P2PChat.Common.html#JsonMessage"><span class="hs-identifier hs-type">JsonMessage</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-73"></a><a name="runAcceptLoop"><a href="P2PChat.Socket.Host.html#runAcceptLoop"><span class="hs-identifier">runAcceptLoop</span></a></a><span> </span><a name="local-6989586621679094680"><a href="#local-6989586621679094680"><span class="hs-identifier">sock</span></a></a><span> </span><a name="local-6989586621679094681"><a href="#local-6989586621679094681"><span class="hs-identifier">chan</span></a></a><span> </span><a name="local-6989586621679094682"><a href="#local-6989586621679094682"><span class="hs-identifier">chanJson</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-74"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679094683"><a href="#local-6989586621679094683"><span class="hs-identifier">con</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679094684"><a href="#local-6989586621679094684"><span class="hs-identifier">peer</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">accept</span><span> </span><a href="#local-6989586621679094680"><span class="hs-identifier hs-var">sock</span></a><span>
</span><a name="line-75"></a><span>  </span><a name="local-6989586621679094685"><a href="#local-6989586621679094685"><span class="hs-identifier">hdl</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">socketToHandle</span><span> </span><a href="#local-6989586621679094683"><span class="hs-identifier hs-var">con</span></a><span> </span><span class="hs-identifier hs-var">ReadWriteMode</span><span>
</span><a name="line-76"></a><span>  </span><span class="hs-identifier hs-var">hSetBuffering</span><span> </span><a href="#local-6989586621679094685"><span class="hs-identifier hs-var">hdl</span></a><span> </span><span class="hs-identifier hs-var">NoBuffering</span><span>
</span><a name="line-77"></a><span>  </span><a name="local-6989586621679094686"><a href="#local-6989586621679094686"><span class="hs-identifier">eof</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">hIsEOF</span><span> </span><a href="#local-6989586621679094685"><span class="hs-identifier hs-var">hdl</span></a><span>
</span><a name="line-78"></a><span>  </span><span class="hs-identifier hs-var">unless</span><span> </span><a href="#local-6989586621679094686"><span class="hs-identifier hs-var">eof</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-79"></a><span>    </span><a name="local-6989586621679094687"><a href="#local-6989586621679094687"><span class="hs-identifier">input</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">B.hGetLine</span><span> </span><a href="#local-6989586621679094685"><span class="hs-identifier hs-var">hdl</span></a><span>
</span><a name="line-80"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679094688"><a href="#local-6989586621679094688"><span class="hs-identifier">json</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">A.decode</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BL.fromStrict</span><span> </span><a href="#local-6989586621679094687"><span class="hs-identifier hs-var">input</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="P2PChat.Common.html#JsonMessage"><span class="hs-identifier hs-type">JsonMessage</span></a><span>
</span><a name="line-81"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679094688"><span class="hs-identifier hs-var">json</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-82"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="P2PChat.Common.html#JsonMessage"><span class="hs-identifier hs-var">JsonMessage</span></a><span> </span><span class="hs-string">&quot;connect&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="P2PChat.Common.html#JsonPayloadConnect"><span class="hs-identifier hs-var">JsonPayloadConnect</span></a><span> </span><a name="local-6989586621679094689"><a href="#local-6989586621679094689"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679094690"><a href="#local-6989586621679094690"><span class="hs-identifier">u</span></a></a><span> </span><a name="local-6989586621679094691"><a href="#local-6989586621679094691"><span class="hs-identifier">p</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-83"></a><span>        </span><a name="local-6989586621679094692"><a href="#local-6989586621679094692"><span class="hs-identifier">peerName</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getPeerName</span><span> </span><a href="#local-6989586621679094683"><span class="hs-identifier hs-var">con</span></a><span>
</span><a name="line-84"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679094693"><a href="#local-6989586621679094693"><span class="hs-identifier">addr</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679094694"><a href="#local-6989586621679094694"><span class="hs-identifier">port</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="P2PChat.Socket.html#fromSockAddr"><span class="hs-identifier hs-var">fromSockAddr</span></a><span> </span><a href="#local-6989586621679094692"><span class="hs-identifier hs-var">peerName</span></a><span>
</span><a name="line-85"></a><span>        </span><span class="hs-identifier hs-var">B.hPutStrLn</span><span> </span><a href="#local-6989586621679094685"><span class="hs-identifier hs-var">hdl</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BL.toStrict</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">A.encode</span><span> </span><a href="P2PChat.Common.html#jsonOK"><span class="hs-identifier hs-var">jsonOK</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-86"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679094695"><a href="#local-6989586621679094695"><span class="hs-identifier">sockCon</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="P2PChat.Socket.Host.html#SockCLientConnection"><span class="hs-identifier hs-var">SockCLientConnection</span></a><span> </span><span class="hs-special">(</span><a href="P2PChat.Common.html#Member"><span class="hs-identifier hs-var">Member</span></a><span> </span><a href="#local-6989586621679094689"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621679094690"><span class="hs-identifier hs-var">u</span></a><span> </span><a href="#local-6989586621679094693"><span class="hs-identifier hs-var">addr</span></a><span> </span><a href="#local-6989586621679094694"><span class="hs-identifier hs-var">port</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679094685"><span class="hs-identifier hs-var">hdl</span></a><span>
</span><a name="line-87"></a><span>        </span><span class="hs-identifier hs-var">writeChan</span><span> </span><a href="#local-6989586621679094681"><span class="hs-identifier hs-var">chan</span></a><span> </span><span class="hs-special">(</span><a href="P2PChat.Socket.Host.html#NewClient"><span class="hs-identifier hs-var">NewClient</span></a><span> </span><a href="#local-6989586621679094695"><span class="hs-identifier hs-var">sockCon</span></a><span class="hs-special">)</span><span>
</span><a name="line-88"></a><span>        </span><a name="local-6989586621679094696"><a href="#local-6989586621679094696"><span class="hs-identifier">clientChan</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">dupChan</span><span> </span><a href="#local-6989586621679094682"><span class="hs-identifier hs-var">chanJson</span></a><span>
</span><a name="line-89"></a><span>        </span><span class="hs-identifier hs-var">forkIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="P2PChat.Socket.Host.html#runClientHandler"><span class="hs-identifier hs-var">runClientHandler</span></a><span> </span><a href="#local-6989586621679094695"><span class="hs-identifier hs-var">sockCon</span></a><span> </span><a href="#local-6989586621679094696"><span class="hs-identifier hs-var">clientChan</span></a><span> </span><a href="#local-6989586621679094681"><span class="hs-identifier hs-var">chan</span></a><span>
</span><a name="line-90"></a><span>        </span><span class="hs-identifier hs-var">putStrLn</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-91"></a><span>      </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">putStrLn</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;DEBUG: Unknown connect msg: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679094687"><span class="hs-identifier hs-var">input</span></a><span>
</span><a name="line-92"></a><span>  </span><a href="P2PChat.Socket.Host.html#runAcceptLoop"><span class="hs-identifier hs-var">runAcceptLoop</span></a><span> </span><a href="#local-6989586621679094680"><span class="hs-identifier hs-var">sock</span></a><span> </span><a href="#local-6989586621679094681"><span class="hs-identifier hs-var">chan</span></a><span> </span><a href="#local-6989586621679094682"><span class="hs-identifier hs-var">chanJson</span></a><span>
</span><a name="line-93"></a><span>
</span><a name="line-94"></a><span class="hs-comment">-- | Handles Input from ALL client sockets, has list of all Clients</span><span>
</span><a name="line-95"></a><span class="hs-identifier">runSockEventHandler</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Chan</span><span> </span><a href="P2PChat.Socket.Host.html#SockEvent"><span class="hs-identifier hs-type">SockEvent</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Chan</span><span> </span><a href="P2PChat.Common.html#Event"><span class="hs-identifier hs-type">Event</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Chan</span><span> </span><a href="P2PChat.Common.html#JsonMessage"><span class="hs-identifier hs-type">JsonMessage</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="P2PChat.Socket.Host.html#SockCLientConnection"><span class="hs-identifier hs-type">SockCLientConnection</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-96"></a><a name="runSockEventHandler"><a href="P2PChat.Socket.Host.html#runSockEventHandler"><span class="hs-identifier">runSockEventHandler</span></a></a><span> </span><a name="local-6989586621679094697"><a href="#local-6989586621679094697"><span class="hs-identifier">chanClient</span></a></a><span> </span><a name="local-6989586621679094698"><a href="#local-6989586621679094698"><span class="hs-identifier">chanHost</span></a></a><span> </span><a name="local-6989586621679094699"><a href="#local-6989586621679094699"><span class="hs-identifier">chanClients</span></a></a><span> </span><a name="local-6989586621679094700"><a href="#local-6989586621679094700"><span class="hs-identifier">members</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-97"></a><span>  </span><a name="local-6989586621679094701"><a href="#local-6989586621679094701"><span class="hs-identifier">sockEvent</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readChan</span><span> </span><a href="#local-6989586621679094697"><span class="hs-identifier hs-var">chanClient</span></a><span>
</span><a name="line-98"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679094701"><span class="hs-identifier hs-var">sockEvent</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-99"></a><span>    </span><a href="P2PChat.Socket.Host.html#NewClient"><span class="hs-identifier hs-var">NewClient</span></a><span> </span><a name="local-6989586621679094702"><a href="#local-6989586621679094702"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-100"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679094703"><a href="#local-6989586621679094703"><span class="hs-identifier">newMembers</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679094700"><span class="hs-identifier hs-var">members</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679094702"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">]</span><span>
</span><a name="line-101"></a><span>      </span><span class="hs-identifier hs-var">writeChan</span><span> </span><a href="#local-6989586621679094699"><span class="hs-identifier hs-var">chanClients</span></a><span> </span><span class="hs-special">(</span><a href="P2PChat.Common.html#jsonClientConnected"><span class="hs-identifier hs-var">jsonClientConnected</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">member</span><span> </span><a href="#local-6989586621679094702"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">member</span><span> </span><a href="#local-6989586621679094703"><span class="hs-identifier hs-var">newMembers</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-102"></a><span>      </span><span class="hs-identifier hs-var">writeChan</span><span> </span><a href="#local-6989586621679094698"><span class="hs-identifier hs-var">chanHost</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="P2PChat.Common.html#SockHostConnect"><span class="hs-identifier hs-var">SockHostConnect</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">member</span><span> </span><a href="#local-6989586621679094702"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">member</span><span> </span><a href="#local-6989586621679094703"><span class="hs-identifier hs-var">newMembers</span></a><span class="hs-special">)</span><span>
</span><a name="line-103"></a><span>      </span><a href="P2PChat.Socket.Host.html#runSockEventHandler"><span class="hs-identifier hs-var">runSockEventHandler</span></a><span> </span><a href="#local-6989586621679094697"><span class="hs-identifier hs-var">chanClient</span></a><span> </span><a href="#local-6989586621679094698"><span class="hs-identifier hs-var">chanHost</span></a><span> </span><a href="#local-6989586621679094699"><span class="hs-identifier hs-var">chanClients</span></a><span> </span><a href="#local-6989586621679094703"><span class="hs-identifier hs-var">newMembers</span></a><span>
</span><a name="line-104"></a><span>    </span><a href="P2PChat.Socket.Host.html#SockInput"><span class="hs-identifier hs-var">SockInput</span></a><span> </span><a name="local-6989586621679094704"><a href="#local-6989586621679094704"><span class="hs-identifier">c</span></a></a><span> </span><a name="local-6989586621679094705"><a href="#local-6989586621679094705"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-105"></a><span>      </span><span class="hs-identifier hs-var">writeChan</span><span> </span><a href="#local-6989586621679094698"><span class="hs-identifier hs-var">chanHost</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="P2PChat.Common.html#SockMsgIn"><span class="hs-identifier hs-var">SockMsgIn</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">mUsername</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">member</span><span> </span><a href="#local-6989586621679094704"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679094705"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-106"></a><span>      </span><span class="hs-identifier hs-var">writeChan</span><span> </span><a href="#local-6989586621679094699"><span class="hs-identifier hs-var">chanClients</span></a><span> </span><span class="hs-special">(</span><a href="P2PChat.Common.html#jsonMessageSend"><span class="hs-identifier hs-var">jsonMessageSend</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">mUsername</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">member</span><span> </span><a href="#local-6989586621679094704"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679094705"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-107"></a><span>      </span><a href="P2PChat.Socket.Host.html#runSockEventHandler"><span class="hs-identifier hs-var">runSockEventHandler</span></a><span> </span><a href="#local-6989586621679094697"><span class="hs-identifier hs-var">chanClient</span></a><span> </span><a href="#local-6989586621679094698"><span class="hs-identifier hs-var">chanHost</span></a><span> </span><a href="#local-6989586621679094699"><span class="hs-identifier hs-var">chanClients</span></a><span> </span><a href="#local-6989586621679094700"><span class="hs-identifier hs-var">members</span></a><span>
</span><a name="line-108"></a><span>    </span><a href="P2PChat.Socket.Host.html#SockOutput"><span class="hs-identifier hs-var">SockOutput</span></a><span> </span><a name="local-6989586621679094706"><a href="#local-6989586621679094706"><span class="hs-identifier">user</span></a></a><span> </span><a name="local-6989586621679094707"><a href="#local-6989586621679094707"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-109"></a><span>      </span><span class="hs-identifier hs-var">writeChan</span><span> </span><a href="#local-6989586621679094699"><span class="hs-identifier hs-var">chanClients</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="P2PChat.Common.html#jsonMessageSend"><span class="hs-identifier hs-var">jsonMessageSend</span></a><span> </span><a href="#local-6989586621679094706"><span class="hs-identifier hs-var">user</span></a><span> </span><a href="#local-6989586621679094707"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-110"></a><span>      </span><a href="P2PChat.Socket.Host.html#runSockEventHandler"><span class="hs-identifier hs-var">runSockEventHandler</span></a><span> </span><a href="#local-6989586621679094697"><span class="hs-identifier hs-var">chanClient</span></a><span> </span><a href="#local-6989586621679094698"><span class="hs-identifier hs-var">chanHost</span></a><span> </span><a href="#local-6989586621679094699"><span class="hs-identifier hs-var">chanClients</span></a><span> </span><a href="#local-6989586621679094700"><span class="hs-identifier hs-var">members</span></a><span>
</span><a name="line-111"></a><span>    </span><a href="P2PChat.Socket.Host.html#SockDisconnect"><span class="hs-identifier hs-var">SockDisconnect</span></a><span> </span><a name="local-6989586621679094708"><a href="#local-6989586621679094708"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-112"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679094709"><a href="#local-6989586621679094709"><span class="hs-identifier">uuid</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mUUID</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">member</span><span> </span><a href="#local-6989586621679094708"><span class="hs-identifier hs-var">c</span></a><span>
</span><a name="line-113"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679094710"><a href="#local-6989586621679094710"><span class="hs-identifier">newMembers</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679094711"><a href="#local-6989586621679094711"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">mUUID</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">member</span><span> </span><a href="#local-6989586621679094711"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">/=</span><span> </span><a href="#local-6989586621679094709"><span class="hs-identifier hs-var">uuid</span></a><span> </span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679094700"><span class="hs-identifier hs-var">members</span></a><span>
</span><a name="line-114"></a><span>      </span><span class="hs-identifier hs-var">writeChan</span><span> </span><a href="#local-6989586621679094699"><span class="hs-identifier hs-var">chanClients</span></a><span> </span><span class="hs-special">(</span><a href="P2PChat.Common.html#jsonClientDisconnected"><span class="hs-identifier hs-var">jsonClientDisconnected</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">member</span><span> </span><a href="#local-6989586621679094708"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">member</span><span> </span><a href="#local-6989586621679094710"><span class="hs-identifier hs-var">newMembers</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-115"></a><span>      </span><span class="hs-identifier hs-var">writeChan</span><span> </span><a href="#local-6989586621679094698"><span class="hs-identifier hs-var">chanHost</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="P2PChat.Common.html#SockHostDisconnect"><span class="hs-identifier hs-var">SockHostDisconnect</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">member</span><span> </span><a href="#local-6989586621679094708"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">member</span><span> </span><a href="#local-6989586621679094710"><span class="hs-identifier hs-var">newMembers</span></a><span class="hs-special">)</span><span>
</span><a name="line-116"></a><span>      </span><a href="P2PChat.Socket.Host.html#runSockEventHandler"><span class="hs-identifier hs-var">runSockEventHandler</span></a><span> </span><a href="#local-6989586621679094697"><span class="hs-identifier hs-var">chanClient</span></a><span> </span><a href="#local-6989586621679094698"><span class="hs-identifier hs-var">chanHost</span></a><span> </span><a href="#local-6989586621679094699"><span class="hs-identifier hs-var">chanClients</span></a><span> </span><a href="#local-6989586621679094710"><span class="hs-identifier hs-var">newMembers</span></a><span>
</span><a name="line-117"></a><span>
</span><a name="line-118"></a><span class="hs-comment">-- | Handles a single client connection, reading and writing</span><span>
</span><a name="line-119"></a><span class="hs-identifier">runClientHandler</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="P2PChat.Socket.Host.html#SockCLientConnection"><span class="hs-identifier hs-type">SockCLientConnection</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Chan</span><span> </span><a href="P2PChat.Common.html#JsonMessage"><span class="hs-identifier hs-type">JsonMessage</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Chan</span><span> </span><a href="P2PChat.Socket.Host.html#SockEvent"><span class="hs-identifier hs-type">SockEvent</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-120"></a><a name="runClientHandler"><a href="P2PChat.Socket.Host.html#runClientHandler"><span class="hs-identifier">runClientHandler</span></a></a><span> </span><a name="local-6989586621679094712"><a href="#local-6989586621679094712"><span class="hs-identifier">sock</span></a></a><span> </span><a name="local-6989586621679094713"><a href="#local-6989586621679094713"><span class="hs-identifier">chanJson</span></a></a><span> </span><a name="local-6989586621679094714"><a href="#local-6989586621679094714"><span class="hs-identifier">chanSockEvent</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-121"></a><span>  </span><a name="local-6989586621679094715"><a href="#local-6989586621679094715"><span class="hs-identifier">outputId</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">forkIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="P2PChat.Socket.Host.html#runSocketOutput"><span class="hs-identifier hs-var">runSocketOutput</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">clientHandle</span><span> </span><a href="#local-6989586621679094712"><span class="hs-identifier hs-var">sock</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679094713"><span class="hs-identifier hs-var">chanJson</span></a><span>
</span><a name="line-122"></a><span>  </span><a href="P2PChat.Socket.Host.html#readClientConnection"><span class="hs-identifier hs-var">readClientConnection</span></a><span> </span><a href="#local-6989586621679094712"><span class="hs-identifier hs-var">sock</span></a><span> </span><a href="#local-6989586621679094714"><span class="hs-identifier hs-var">chanSockEvent</span></a><span>
</span><a name="line-123"></a><span>  </span><span class="hs-identifier hs-var">killThread</span><span> </span><a href="#local-6989586621679094715"><span class="hs-identifier hs-var">outputId</span></a><span>
</span><a name="line-124"></a><span>  </span><span class="hs-identifier hs-var">hClose</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">clientHandle</span><span> </span><a href="#local-6989586621679094712"><span class="hs-identifier hs-var">sock</span></a><span class="hs-special">)</span><span>
</span><a name="line-125"></a><span>  </span><span class="hs-identifier hs-var">writeChan</span><span> </span><a href="#local-6989586621679094714"><span class="hs-identifier hs-var">chanSockEvent</span></a><span> </span><span class="hs-special">(</span><a href="P2PChat.Socket.Host.html#SockDisconnect"><span class="hs-identifier hs-var">SockDisconnect</span></a><span> </span><a href="#local-6989586621679094712"><span class="hs-identifier hs-var">sock</span></a><span class="hs-special">)</span><span>
</span><a name="line-126"></a><span>
</span><a name="line-127"></a><span class="hs-comment">-- | Runs socket output, if we timeout we send a heartbeat</span><span>
</span><a name="line-128"></a><span class="hs-identifier">runSocketOutput</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Handle</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Chan</span><span> </span><a href="P2PChat.Common.html#JsonMessage"><span class="hs-identifier hs-type">JsonMessage</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-129"></a><a name="runSocketOutput"><a href="P2PChat.Socket.Host.html#runSocketOutput"><span class="hs-identifier">runSocketOutput</span></a></a><span> </span><a name="local-6989586621679094716"><a href="#local-6989586621679094716"><span class="hs-identifier">hdl</span></a></a><span> </span><a name="local-6989586621679094717"><a href="#local-6989586621679094717"><span class="hs-identifier">chan</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-130"></a><span>  </span><a name="local-6989586621679094718"><a href="#local-6989586621679094718"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">timeout</span><span> </span><span class="hs-number">500000</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">readChan</span><span> </span><a href="#local-6989586621679094717"><span class="hs-identifier hs-var">chan</span></a><span>
</span><a name="line-131"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679094718"><span class="hs-identifier hs-var">msg</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-132"></a><span>    </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679094719"><a href="#local-6989586621679094719"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">B.hPutStrLn</span><span> </span><a href="#local-6989586621679094716"><span class="hs-identifier hs-var">hdl</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">BL.toStrict</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">A.encode</span><span> </span><a href="#local-6989586621679094719"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-133"></a><span>    </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">B.hPutStrLn</span><span> </span><a href="#local-6989586621679094716"><span class="hs-identifier hs-var">hdl</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">BL.toStrict</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">A.encode</span><span> </span><a href="P2PChat.Common.html#jsonHeartbeat"><span class="hs-identifier hs-var">jsonHeartbeat</span></a><span>
</span><a name="line-134"></a><span>  </span><a href="P2PChat.Socket.Host.html#runSocketOutput"><span class="hs-identifier hs-var">runSocketOutput</span></a><span> </span><a href="#local-6989586621679094716"><span class="hs-identifier hs-var">hdl</span></a><span> </span><a href="#local-6989586621679094717"><span class="hs-identifier hs-var">chan</span></a><span>
</span><a name="line-135"></a><span>
</span><a name="line-136"></a><span class="hs-comment">-- | Runs socket input, on timeout (this includes not receiving a heartbeat) returns</span><span>
</span><a name="line-137"></a><span class="hs-identifier">readClientConnection</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="P2PChat.Socket.Host.html#SockCLientConnection"><span class="hs-identifier hs-type">SockCLientConnection</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Chan</span><span> </span><a href="P2PChat.Socket.Host.html#SockEvent"><span class="hs-identifier hs-type">SockEvent</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-138"></a><a name="readClientConnection"><a href="P2PChat.Socket.Host.html#readClientConnection"><span class="hs-identifier">readClientConnection</span></a></a><span> </span><a name="local-6989586621679094720"><a href="#local-6989586621679094720"><span class="hs-identifier">client</span></a></a><span> </span><a name="local-6989586621679094721"><a href="#local-6989586621679094721"><span class="hs-identifier">chan</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-139"></a><span>  </span><a name="local-6989586621679094722"><a href="#local-6989586621679094722"><span class="hs-identifier">input</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">timeout</span><span> </span><span class="hs-number">1000000</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="P2PChat.Socket.html#readHandle"><span class="hs-identifier hs-var">readHandle</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">clientHandle</span><span> </span><a href="#local-6989586621679094720"><span class="hs-identifier hs-var">client</span></a><span class="hs-special">)</span><span>
</span><a name="line-140"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679094722"><span class="hs-identifier hs-var">input</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-141"></a><span>    </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679094723"><a href="#local-6989586621679094723"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-142"></a><span>      </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679094723"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-143"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679094724"><a href="#local-6989586621679094724"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-144"></a><span>          </span><span class="hs-keyword">case</span><span> </span><a href="P2PChat.Common.html#jsonParse"><span class="hs-identifier hs-var">jsonParse</span></a><span> </span><a href="#local-6989586621679094724"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-145"></a><span>            </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679094725"><a href="#local-6989586621679094725"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="P2PChat.Socket.Host.html#handleInput"><span class="hs-identifier hs-var">handleInput</span></a><span> </span><a href="#local-6989586621679094720"><span class="hs-identifier hs-var">client</span></a><span> </span><a href="#local-6989586621679094721"><span class="hs-identifier hs-var">chan</span></a><span> </span><a href="#local-6989586621679094725"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-146"></a><span>            </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">putStrLn</span><span> </span><span class="hs-string">&quot;DEBUG: Client Reading unknown msg&quot;</span><span>
</span><a name="line-147"></a><span>          </span><a href="P2PChat.Socket.Host.html#readClientConnection"><span class="hs-identifier hs-var">readClientConnection</span></a><span> </span><a href="#local-6989586621679094720"><span class="hs-identifier hs-var">client</span></a><span> </span><a href="#local-6989586621679094721"><span class="hs-identifier hs-var">chan</span></a><span>
</span><a name="line-148"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-149"></a><span>    </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-150"></a><span>
</span><a name="line-151"></a><span class="hs-comment">-- | Parses raw Input into JsonMessage and forwards to appropriate handler</span><span>
</span><a name="line-152"></a><span class="hs-identifier">handleInput</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="P2PChat.Socket.Host.html#SockCLientConnection"><span class="hs-identifier hs-type">SockCLientConnection</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Chan</span><span> </span><a href="P2PChat.Socket.Host.html#SockEvent"><span class="hs-identifier hs-type">SockEvent</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="P2PChat.Common.html#JsonMessage"><span class="hs-identifier hs-type">JsonMessage</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-153"></a><a name="handleInput"><a href="P2PChat.Socket.Host.html#handleInput"><span class="hs-identifier">handleInput</span></a></a><span> </span><a name="local-6989586621679094726"><a href="#local-6989586621679094726"><span class="hs-identifier">client</span></a></a><span> </span><a name="local-6989586621679094727"><a href="#local-6989586621679094727"><span class="hs-identifier">chan</span></a></a><span> </span><a name="local-6989586621679094728"><a href="#local-6989586621679094728"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679094728"><span class="hs-identifier hs-var">msg</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-154"></a><span>  </span><span class="hs-special">(</span><a href="P2PChat.Common.html#JsonMessage"><span class="hs-identifier hs-var">JsonMessage</span></a><span> </span><span class="hs-string">&quot;message&quot;</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="P2PChat.Common.html#JsonPayloadMessage"><span class="hs-identifier hs-var">JsonPayloadMessage</span></a><span> </span><a name="local-6989586621679094729"><a href="#local-6989586621679094729"><span class="hs-identifier">user</span></a></a><span> </span><a name="local-6989586621679094730"><a href="#local-6989586621679094730"><span class="hs-identifier">m</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">writeChan</span><span> </span><a href="#local-6989586621679094727"><span class="hs-identifier hs-var">chan</span></a><span> </span><span class="hs-special">(</span><a href="P2PChat.Socket.Host.html#SockInput"><span class="hs-identifier hs-var">SockInput</span></a><span> </span><a href="#local-6989586621679094726"><span class="hs-identifier hs-var">client</span></a><span> </span><a href="#local-6989586621679094730"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-155"></a><span>  </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></pre></body></html>